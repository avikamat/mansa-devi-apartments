<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Society Maintenance Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial, sans-serif;display:flex;justify-content:center;padding:0;background:#f7f7f7;}
.container{max-width:450px;width:100%;padding:15px;}
.top-section{display:flex;flex-wrap:wrap;justify-content:space-between;gap:10px;}
button{flex:1;min-width:120px;padding:12px;font-size:16px;font-weight:bold;cursor:pointer;border-radius:8px;border:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #ddd;padding:10px;font-size:16px;text-align:center;}
.status-btn{width:100%;padding:10px;border-radius:6px;font-size:15px;font-weight:bold;}
.paid-btn{background:#2ecc71!important;color:white;}
.pending-btn{background:#ff6b6b!important;color:white;}
.table-wrapper{overflow-x:auto;}
#flatsContainer{padding-bottom:100px;}
@media(max-width:450px){#flatsContainer{padding-bottom:140px;}}
#cashModal {
  z-index: 9999;
}

body.modal-open {
  overflow: hidden; /* stop background scroll */
}

</style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- Payment Option Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded shadow w-80">
    <h2 class="text-lg font-bold mb-4 text-center">Select Payment Method</h2>
    <button onclick="openUPIModal()" class="bg-blue-600 text-white p-2 rounded w-full mb-2">Pay via UPI</button>
    <button onclick="openCashModal()" class="bg-purple-600 text-white p-2 rounded w-full mb-2">Cash Receipt</button>
    <button onclick="closePaymentModal()" class="bg-gray-400 text-white p-2 rounded w-full">Cancel</button>
  </div>
</div>

<!-- UPI Modal -->
<div id="upiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-5 rounded shadow w-80">
    <h2 class="font-bold text-lg mb-3 text-center">UPI Payment</h2>

    <input id="upiName" placeholder="Your Name" class="w-full p-2 border mb-2 rounded">
    <input id="upiFlat" placeholder="Flat Number (e.g. 0803 or G05)" class="w-full p-2 border mb-2 rounded">
    <input id="upiFloor" placeholder="Floor (0 for Ground)" class="w-full p-2 border mb-2 rounded">

    <button onclick="processUPI()" class="bg-blue-600 text-white p-2 rounded w-full mb-2">Proceed to Pay ₹100</button>
    <button onclick="closeUPIModal()" class="bg-gray-400 text-white p-2 rounded w-full">Cancel</button>
  </div>
</div>

<!-- Cash Receipt Modal -->
<div id="cashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-5 rounded shadow w-80">
    <h2 class="font-bold text-lg mb-3 text-center">Cash Payment Receipt</h2>
    <input id="custName" placeholder="Your Name" class="w-full p-2 border mb-2 rounded">
    <input id="flatNo" placeholder="Flat Number (e.g. 0803 or G05)" class="w-full p-2 border mb-2 rounded">
    <input id="floorNo" placeholder="Floor (0 for Ground)" class="w-full p-2 border mb-2 rounded">
    <input id="amount" placeholder="Amount (₹)" type="number" class="w-full p-2 border mb-3 rounded">
    <button onclick="generateCashReceipt()" class="bg-green-600 text-white p-2 rounded w-full mb-2">Generate Receipt</button>
    <button onclick="closeCashModal()" class="bg-gray-400 text-white p-2 rounded w-full">Cancel</button>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded shadow w-80">
    <h2 class="text-lg font-bold mb-3 text-center">Admin Login</h2>
    <input id="adminPass" type="password" placeholder="Enter Password" class="w-full p-2 border rounded mb-3">
    <button onclick="checkLogin()" class="w-full bg-blue-600 text-white p-2 rounded">Login</button>
    <button onclick="closeLogin()" class="w-full mt-2 bg-gray-400 text-white p-2 rounded">Cancel</button>
  </div>
</div>

<header class="bg-blue-700 text-white p-4 text-center shadow">
  <h1 class="text-2xl font-bold">Mansa Devi Apartments Maintenance</h1>
  <p class="text-sm">Admin Panel / प्रशासन</p>
</header>

<div class="p-4 flex justify-between items-center gap-2 flex-wrap">
  <button onclick="openLogin()" id="loginBtn" class="bg-gray-700 text-white px-4 py-2 rounded">Admin Login</button>
  <button onclick="logout()" id="logoutBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  <div>
    <label class="font-semibold">Month: </label>
    <select id="monthSelect" class="p-2 border rounded" onchange="resetPayments()"></select>
  </div>
</div>

<div class="p-4 text-lg font-bold text-blue-800">
  Total Collection This Month: ₹<span id="totalCollection">0</span>
</div>

<div class="p-4 flex justify-between items-center flex-wrap gap-2">
  <div>
    <label class="font-semibold mb-2 block">Select Floor</label>
    <select id="floorSelect" class="p-3 border rounded text-lg" onchange="loadFloor()"></select>
  </div>
  <button onclick="exportPDF()" class="bg-green-600 text-white px-4 py-2 rounded">Export PDF</button>
  <button onclick="openPaymentModal()" class="bg-purple-700 text-white px-4 py-2 rounded">Pay Maintenance</button>
</div>

<div class="grid grid-cols-2 gap-4 px-4">
  <div class="bg-green-200 p-3 rounded text-center font-bold">Paid: <span id="paidCount">0</span></div>
  <div class="bg-red-200 p-3 rounded text-center font-bold">Pending: <span id="pendingCount">0</span></div>
</div>

<div class="p-4 text-center font-semibold text-purple-700">
  Floor Total: ₹<span id="floorTotal">0</span>
</div>

<div id="flatsContainer" class="grid grid-cols-3 gap-3 p-4 pb-24"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://qzeytcaxkjarhzrtsaeo.supabase.co";
const SUPABASE_KEY = "YOUR_KEY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<script>
// ---- Data Config ----
const totalFloors = 24;
const flatsPerFloor = 20;
const fee = 100;
let loggedIn = false;

let data = JSON.parse(localStorage.getItem("maintenanceData")) || {};
function saveData(){ localStorage.setItem("maintenanceData", JSON.stringify(data)); }

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const monthSelect=document.getElementById('monthSelect');
months.forEach(m=>{let o=document.createElement('option');o.value=m;o.textContent=m;monthSelect.appendChild(o);});

const floorSelect=document.getElementById('floorSelect');
let o0=document.createElement('option');o0.value=0;o0.textContent=`Ground`;floorSelect.appendChild(o0);
for(let f=1;f<=totalFloors;f++){let o=document.createElement('option');o.value=f;o.textContent=`Floor ${f}`;floorSelect.appendChild(o);} 

// ---- UI & Logic ----
async function resetPayments(){
  let m = monthSelect.value;
  if(!data[m]) data[m] = {};
  saveData();
  loadFloor();
  updateTotals();
}

function loadFloor(){
  const month=monthSelect.value;
  if(!data[month])data[month]={};
  const floor=floorSelect.value;
  const flatsContainer=document.getElementById('flatsContainer');
  flatsContainer.innerHTML='';

  let paid=0,floorTotal=0;

  for(let n=1;n<=flatsPerFloor;n++){
    const flat=`${String(floor).padStart(2,'0')}${String(n).padStart(2,'0')}`;
    const isPaid=data[month][flat]===true;
    if(isPaid){paid++;floorTotal+=fee;}

    flatsContainer.innerHTML+=`
      <button onclick="togglePaid('${flat}')" class="p-3 rounded font-bold text-sm shadow text-white ${isPaid?'bg-green-600':'bg-red-600'} ${loggedIn?'':'opacity-40 cursor-not-allowed'}">
        ${flat}<br>${isPaid?'✅ Paid':'❌ Pending'}
      </button>`;
  }

  document.getElementById('paidCount').textContent=paid;
  document.getElementById('pendingCount').textContent=flatsPerFloor-paid;
  document.getElementById('floorTotal').textContent=floorTotal;
  updateTotals();
}

async function togglePaid(flat){
  if(!loggedIn) return alert("Login required");
  const month = monthSelect.value;
  data[month][flat] = !data[month][flat];
  saveData();loadFloor();
}

function updateTotals(){
  const month=monthSelect.value;let total=0;
  if(data[month])Object.values(data[month]).forEach(p=>{if(p)total+=fee;});
  document.getElementById('totalCollection').textContent=total;
}

function openLogin(){document.getElementById('loginModal').classList.remove('hidden');}
function closeLogin(){document.getElementById('loginModal').classList.add('hidden');}
function checkLogin(){if(document.getElementById('adminPass').value==="mansa1812"){loggedIn=true;closeLogin();document.getElementById('loginBtn').classList.add('hidden');document.getElementById('logoutBtn').classList.remove('hidden');loadFloor();}else alert("Wrong password");}
function logout(){loggedIn=false;document.getElementById('logoutBtn').classList.add('hidden');document.getElementById('loginBtn').classList.remove('hidden');loadFloor();}

// ----- Payment Buttons -----
function openPaymentModal(){document.getElementById('paymentModal').classList.remove("hidden");}
function closePaymentModal(){document.getElementById('paymentModal').classList.add("hidden");}
function openUPIModal(){closePaymentModal();document.getElementById('upiModal').classList.remove("hidden");}
function closeUPIModal(){document.getElementById('upiModal').classList.add("hidden");}
function openCashModal(){closePaymentModal();document.getElementById('cashModal').classList.remove("hidden");}
function closeCashModal(){document.getElementById('cashModal').classList.add("hidden");}

// ----- UPI Payment Process -----
function processUPI(){
  const name=document.getElementById('upiName').value;
  const flat=document.getElementById('upiFlat').value.toUpperCase();
  const floor=document.getElementById('upiFloor').value;
  if(!name||!flat||!floor)return alert("Fill all fields");

  const upiId="43933805949@sbi";
  const amount="100";
  const receipt = Date.now();

  const upiUrl = `upi://pay?pa=${upiId}&pn=MansaDeviE3&am=${amount}&cu=INR&tn=Maintenance-${flat}`;
  window.location.href=upiUrl;

  setTimeout(()=>{
    const waText = 
`Hi, I paid ₹100 maintenance.
Name: ${name}
Flat: ${flat}
Floor: ${floor}
Receipt ID: ${receipt}`;
    Please attach the payment screenshot here for proof
    
    const waGroup = "https://chat.whatsapp.com/Jdr5nVIqp5R1Fvolg0UGHf";
    window.open(`https://wa.me/?text=${encodeURIComponent(waText)}%0A${encodeURIComponent(waGroup)}`);
  },2000);

  closeUPIModal();
}

// ---- Cash PDF ----
async function generateCashReceipt() {
  const { jsPDF } = window.jspdf;
  const name=document.getElementById('custName').value;
  const flat=document.getElementById('flatNo').value.toUpperCase();
  const floor=document.getElementById('floorNo').value;
  const amount=document.getElementById('amount').value;
  if(!name||!flat||!floor||!amount)return alert("Fill all fields");

  const doc=new jsPDF();
  doc.setFontSize(18);
  doc.text("Mansa Devi Apartments - E3",10,10);
  doc.setFontSize(14);
  doc.text("Maintenance Cash Receipt",10,20);
  doc.line(10,23,200,23);
  const date=new Date().toLocaleDateString();
  doc.setFontSize(12);
  doc.text(`Date: ${date}`,10,32);
  doc.text(`Name: ${name}`,10,40);
  doc.text(`Flat No: ${flat}`,10,48);
  doc.text(`Floor: ${floor}`,10,56);
  doc.text(`Amount Paid: ₹${amount}`,10,64);
  doc.text("Payment Mode: CASH",10,74);
  doc.text("Submit cash to Flat 1812 (E3)",10,88);
  doc.line(10,105,80,105);
  doc.text("Resident Signature",10,112);
  doc.save(`Cash-Receipt-${flat}.pdf`);
  closeCashModal();
}

// ---- Export PDF ----
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const month=monthSelect.value;
  const monthData=data[month]||{};
  doc.setFontSize(16);
  doc.text(`Maintenance Report - ${month}`,10,10);
  doc.setFontSize(12);
  let y=20;
  doc.text("Flat No",10,y);doc.text("Status",50,y);y+=8;doc.line(10,y,200,y);y+=5;
  Object.keys(monthData).sort().forEach(flat=>{
    const status=monthData[flat]?"Paid ✅":"Pending ❌";
    doc.text(flat,10,y);doc.text(status,50,y);y+=7;
  });
  doc.save(`Maintenance-${month}.pdf`);
}

// ---- Init ----
monthSelect.value=months[new Date().getMonth()];
floorSelect.value=0;
resetPayments();
</script>
</body>
</html>










