<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Society Maintenance Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* Base Styles */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  display: flex;
  justify-content: center;
  padding: 0;
  background: #f7f8fc; /* Soft background */
}
/* General Button Styling for consistent look */
button:not([id*="loginBtn"], [id*="logoutBtn"], [id*="PayBtn"], [id*="Select"], [id*="exportPDF"], [id*="AnalyticsBtn"]) {
  /* This targets the flat buttons in the list */
  transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
}
button:hover:not(:disabled) {
  opacity: 1; /* Ensure hover opacity is not lower than normal */
  transform: translateY(-2px); /* Lift effect on hover */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.receipt-pdf {
    display: none; /* Hidden container for PDF generation */
    padding: 20px;
    background-color: white;
    font-family: sans-serif;
    border: 1px solid #000;
}

/* Fix for mobile: Ensure the main content card fills the screen width */
.main-card-container {
    width: 100%;
    max-width: 600px; /* Adjusted max width for better desktop visibility */
    margin-left: auto;
    margin-right: auto;
}

/* Mobile specific grid adjustments for flat buttons */
@media (max-width: 400px) {
  #flatsContainer {
    grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on very small screens */
  }
}
</style>

</head>
<body class="bg-indigo-50 min-h-screen flex flex-col">

<div id="messageToast" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white bg-red-500 z-50 hidden transition-opacity duration-300"></div>

<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-xs">
    <h2 class="text-xl font-extrabold mb-4 text-center text-blue-700">Admin Login</h2>
    <input id="adminPass" type="password" placeholder="Enter Password" class="w-full p-3 border border-gray-300 rounded-lg mb-4 shadow-sm focus:ring-blue-500 focus:border-blue-500">
    <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold shadow-md">Login</button>
    <button onclick="closeLogin()" class="w-full mt-3 bg-gray-400 hover:bg-gray-500 text-white p-3 rounded-lg font-bold">Cancel</button>
  </div>
</div>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
  <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
    <h2 id="paymentModalTitle" class="text-xl font-extrabold mb-4 text-center text-green-700">Pay Maintenance</h2>
    
    <div id="paymentForm">
        <input id="payName" type="text" placeholder="Your Name" class="w-full p-3 border border-gray-300 rounded-lg mb-3 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
        <input id="payFlatNo" type="text" placeholder="Flat No. (e.g., 1812, G05)" class="w-full p-3 border border-gray-300 rounded-lg mb-3 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
        <input id="payFloorNo" type="number" placeholder="Floor No. (e.g., 18, 0)" class="w-full p-3 border border-gray-300 rounded-lg mb-3 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
        <div class="flex items-center bg-green-50 p-3 rounded-lg mb-4 shadow-inner">
            <span class="font-semibold text-gray-700 mr-2">Amount Due:</span>
            <span id="payAmount" class="text-xl font-extrabold text-green-700">‚Çπ100</span>
        </div>
        
        <button id="cashPayBtn" onclick="handlePaymentSelection('cash')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg font-bold shadow-md transition duration-150 hidden">
            Generate Cash Receipt
        </button>
        <button id="upiPayBtn" onclick="handlePaymentSelection('upi')" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold shadow-md transition duration-150 hidden">
            Pay ‚Çπ100 via UPI
        </button>
    </div>

    <div id="upiConfirmation" class="hidden text-center">
        <p class="text-lg font-semibold text-gray-700 mb-4 bg-yellow-100 p-3 rounded-lg">
            Payment link opened! Please complete the transaction on your app.
        </p>
        <button 
            id="whatsappNotifyBtn" 
            onclick="redirectToWhatsApp()" 
            disabled 
            class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-bold shadow-lg opacity-50 cursor-not-allowed transition duration-150">
            (Wait 10 seconds...)
        </button>
    </div>

    <button onclick="closePaymentModal()" class="w-full mt-4 bg-gray-400 hover:bg-gray-500 text-white p-3 rounded-lg font-bold">Cancel</button>
  </div>
</div>

<div class="main-card-container mx-auto my-0 sm:my-6 bg-white rounded-none sm:rounded-xl shadow-2xl overflow-hidden min-h-screen sm:min-h-0">

<header class="bg-gradient-to-r from-blue-700 to-indigo-600 text-white p-5 text-center shadow-lg flex items-center justify-center gap-3">
  <img src="e3.png" alt="E3 Logo" class="h-10 w-10 rounded-full border-2 border-white shadow-md">
  <div>
    <h1 class="text-2xl font-extrabold tracking-wide">Mansa Devi Apartments</h1>
    <p class="text-sm opacity-90">Maintenance Portal / ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§®</p>
  </div>
</header>

<div class="p-4 border-b border-gray-100">
    <button onclick="openPaymentModal(true)" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-4 py-4 rounded-xl font-extrabold text-lg shadow-lg transition duration-300 transform hover:scale-[1.01]">
        Pay Maintenance / ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç
    </button>
</div>

<div class="p-4 pt-0 border-b border-gray-100">
  <button id="AnalyticsBtn" onclick="showMonthlyAnalytics()" class="bg-purple-600 hover:bg-purple-700 text-white w-full px-4 py-3 rounded-lg font-bold shadow-md transition duration-150">Monthly Analytics / ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</button>
</div>
<div class="p-4 flex justify-between items-center gap-2 flex-wrap border-b border-gray-100">
  <div class="flex gap-2">
    <button onclick="openLogin()" id="loginBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg text-sm shadow-md">Admin Login</button>
    <button onclick="logout()" id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm shadow-md">Logout</button>
  </div>
  <div>
    <label class="font-semibold text-gray-700">Month:</label>
    <select id="monthSelect" class="p-2 border border-gray-300 rounded-lg shadow-sm" onchange="resetPayments()"></select>
  </div>
</div>

<div class="p-4 bg-indigo-50 text-xl font-extrabold text-blue-800 text-center border-b border-gray-200 shadow-inner">
  Total Collection This Month: ‚Çπ<span id="totalCollection">0</span>
</div>

<div class="p-4 flex justify-between items-center flex-wrap gap-3 border-b border-gray-100">
  <div>
    <label class="font-semibold mb-1 block text-gray-700">Select Floor:</label>
    <select id="floorSelect" class="p-3 border border-gray-300 rounded-lg text-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="loadFloor()"></select>
  </div>
  <button onclick="exportPDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold shadow-md transition duration-150">Export PDF Report</button>
</div>

<div class="grid grid-cols-2 gap-4 px-4 py-4 border-b border-gray-100">
  <div class="bg-white border border-green-300 p-4 rounded-xl text-center shadow-lg">
    <div class="font-bold text-lg text-green-700">Paid / ‡§ú‡§Æ‡§æ</div>
    <span id="paidCount" class="text-3xl font-extrabold text-green-600">0</span>
  </div>
  <div class="bg-white border border-red-300 p-4 rounded-xl text-center shadow-lg">
    <div class="font-bold text-lg text-red-700">Pending / ‡§¨‡§æ‡§ï‡•Ä</div>
    <span id="pendingCount" class="text-3xl font-extrabold text-red-600">0</span>
  </div>
</div>

<div class="p-4 text-center font-bold text-lg text-purple-700 bg-purple-50 shadow-inner">
  Floor Total Collected: ‚Çπ<span id="floorTotal">0</span>
</div>

<div id="flatsContainer" class="grid grid-cols-3 gap-3 p-4 pb-12"></div>

</div> <div id="receiptContainer" class="receipt-pdf">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-800 border-b-2 pb-2">Maintenance Cash Receipt</h1>
    <div class="mb-6 text-base bg-gray-50 p-3 rounded-lg shadow-inner">
        <p><strong>Date:</strong> <span id="receiptDate"></span></p>
        <p><strong>Receipt ID:</strong> <span id="receiptID"></span></p>
    </div>
    
    <div class="grid grid-cols-2 gap-4 mb-8">
        <p class="border-b pb-1"><strong>Name:</strong> <span id="receiptName" class="font-semibold"></span></p>
        <p class="border-b pb-1"><strong>Amount:</strong> <span id="receiptAmount" class="font-extrabold text-red-600">‚Çπ</span></p>
        <p class="border-b pb-1"><strong>Flat No:</strong> <span id="receiptFlat" class="font-semibold"></span></p>
        <p class="border-b pb-1"><strong>Floor No:</strong> <span id="receiptFloor" class="font-semibold"></span></p>
    </div>
    
    <h2 class="text-xl font-bold mt-6 mb-2 border-t pt-4">Payment Instructions (CASH)</h2>
    <p class="text-red-600 font-semibold text-lg">
        Please deposit this cash amount at the following destination:
    </p>
    <p class="text-2xl font-extrabold text-blue-700 mt-2 p-3 bg-blue-100 rounded-lg">
        Flat No. 1812 E3
    </p>
    
    <div class="mt-8 text-center border-t pt-4">
        <p class="text-sm">Thank you for your timely payment.</p>
        <p class="mt-2 text-xl font-extrabold text-blue-900">Mansa Devi Apartments</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Configuration & Constants ---
const SUPABASE_URL = "https://qzeytcaxkjarhzrtsaeo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXl0Y2F4a2phcmh6cnRzYWVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTY0NzQsImV4cCI6MjA3NzMzMjQ3NH0.x0Al5WhA1OT3ryFJXPQbQQtf4AyhkOxW08JtOTpJQiM";
const UPI_ID = "43933805949@sbi"; // !!! REPLACE WITH YOUR ACTUAL UPI ID !!!
const WHATSAPP_LINK = "https://chat.whatsapp.com/Jdr5nVIqp5R1Fvolg0UGHf?mode=wwt"; // !!! REPLACE WITH YOUR ACTUAL WHATSAPP INVITE LINK !!!
const UPI_PAYEE_NAME = "Mansa Devi Maint.";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const totalFloors = 24;
const flatsPerFloor = 20;
const fee = 100;
let loggedIn = false;

let data = JSON.parse(localStorage.getItem("maintenanceData")) || {};
function saveData(){ localStorage.setItem("maintenanceData", JSON.stringify(data)); }

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const monthSelect=document.getElementById('monthSelect');
months.forEach(m=>{let o=document.createElement('option');o.value=m;o.textContent=m;monthSelect.appendChild(o);});

const floorSelect=document.getElementById('floorSelect');
// Add Ground Floor
let g = document.createElement('option');
g.value = 0;
g.textContent = "Ground";
floorSelect.appendChild(g);

// Add Floors 1 to 24
for(let f=1;f<=totalFloors;f++){
  let o=document.createElement('option');
  o.value=f;
  o.textContent=`Floor ${f}`;
  floorSelect.appendChild(o);
}
 
// ---------- Message/Toast Functions (Replaces alert()) ----------
const messageToast = document.getElementById('messageToast');

function showMessage(msg, isError = true) {
    messageToast.textContent = msg;
    messageToast.classList.remove('hidden');
    messageToast.classList.toggle('bg-red-500', isError);
    messageToast.classList.toggle('bg-green-500', !isError);
    setTimeout(() => {
        messageToast.classList.add('hidden');
    }, 3000);
}

// ---------- Supabase DB helpers (correct) ----------
async function loadFromDB(month) {
  const { data: rows, error } = await supabase

    .from('payments')
    .select('*')
    .eq('month', month);

  if (error) {
    console.error("Supabase load error:", error);
    return;
  }

  data[month] = {};
  rows.forEach(r => {
    data[month][String(r.flat)] = Number(r.count) || 0;
  });
}

async function saveToDB(flat, month, count, floor) {
  const payload = { flat: String(flat), month: String(month), floor: Number(floor), count: Number(count) };

  const { error } = await supabase

    .from('payments')
    .upsert(payload, { onConflict: ['flat','month','floor'] });

  if (error) console.error("Supabase save error:", error);
}
// ---------- end DB helpers ----------


async function resetPayments(){
  let m = monthSelect.value;
  if(!data[m]) data[m] = {};
  
  await loadFromDB(m);
  saveData();
  loadFloor();
  updateTotals();
}

async function loadFloor(){
  const month = monthSelect.value;
  const floor = floorSelect.value;

  await loadFromDB(month);

  const flatsContainer = document.getElementById('flatsContainer');
  flatsContainer.innerHTML = '';
// Always initialize 20 flats per floor, even if DB empty
if (!data[month]) data[month] = {};

for (let n = 1; n <= flatsPerFloor; n++) {
  let flat;
if (floor == 0) {
  flat = `G${String(n).padStart(2,'0')}`; 
} else {
  flat = `${String(floor).padStart(2,'0')}${String(n).padStart(2,'0')}`;
}

  // If no record exists in memory, create default
  if (data[month][flat] === undefined || data[month][flat] === null) {
    data[month][flat] = 0;
  }
}


  let paid = 0;
  let floorTotal = 0;

  for (let n = 1; n <= flatsPerFloor; n++) {
    let flat;
if (floor == 0) {
  flat = `G${String(n).padStart(2,'0')}`; 
} else {
  flat = `${String(floor).padStart(2,'0')}${String(n).padStart(2,'0')}`;
}

    const countVal = Number(data[month][flat] || 0);
    const paidAmount = countVal * fee;
    const isPaid = paidAmount > 0;

    if (isPaid) { paid++; floorTotal += paidAmount; }

    // Enhanced Button Look for Flats
    flatsContainer.innerHTML += `
      <button onclick="togglePaid('${flat}')"
        class="p-3 rounded-lg text-xs font-bold shadow-md text-white transition duration-150 transform hover:scale-[1.03] ${isPaid ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} ${loggedIn ? '' : 'opacity-70 cursor-not-allowed'}">
        ${flat}<br>${isPaid ? '‚úÖ Paid ‚Çπ' + paidAmount : '‚ùå Pending / ‡§¨‡§æ‡§ï‡•Ä'}
      </button>`;
  }

  document.getElementById('paidCount').textContent = paid;
  document.getElementById('pendingCount').textContent = flatsPerFloor - paid;
  document.getElementById('floorTotal').textContent = floorTotal;

  updateTotals();
}


async function togglePaid(flat) {
  if (!loggedIn) return showMessage("Login required for Admin actions.", true);

  const month = monthSelect.value;
  const floor = floorSelect.value;

  if (!data[month]) data[month] = {};

  let current = Number(data[month][flat] || 0);
  current = current + 1;
  if (current > 5) current = 0; // cycles after 5 -> reset

  data[month][flat] = current;
  try { saveData(); } catch(e){}

  await saveToDB(flat, month, current, floor);
  loadFloor();
}


async function updateTotals(){
  const month = monthSelect.value;
  if (!data[month]) await loadFromDB(month);

  let total = 0;
  Object.values(data[month] || {}).forEach(count => {
    total += (Number(count) || 0) * fee;
  });

  document.getElementById('totalCollection').textContent = total;
}


function openLogin(){document.getElementById('loginModal').classList.remove('hidden');}
function closeLogin(){document.getElementById('loginModal').classList.add('hidden');}
function checkLogin(){if(document.getElementById('adminPass').value==="mansa1812"){loggedIn=true;closeLogin();document.getElementById('loginBtn').classList.add('hidden');document.getElementById('logoutBtn').classList.remove('hidden');loadFloor(); showMessage("Admin logged in successfully!", false);}else showMessage("Wrong password", true);}
function logout(){loggedIn=false;document.getElementById('logoutBtn').classList.add('hidden');document.getElementById('loginBtn').classList.remove('hidden');loadFloor(); showMessage("Logged out.", false);}

// --- UPDATED PDF EXPORT FUNCTION (Filtered + High Quality Text/Line Drawing) ---
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const month = monthSelect.value;
    const monthData = data[month] || {};
    
    // --- 1. Filter and Prepare Records (ONLY PAID FLATS) ---
    let totalPaidAmount = 0;
    let paidFlats = 0;
    const paidRecords = []; 
    
    Object.keys(monthData).sort((a, b) => {
        // Advanced sorting: G Flats first, then numerically by floor/flat number
        const aIsG = a.startsWith('G');
        const bIsG = b.startsWith('G');
        if (aIsG !== bIsG) return aIsG ? -1 : 1;
        
        const aNum = Number(a.match(/\d+/g).join(''));
        const bNum = Number(b.match(/\d+/g).join(''));
        return aNum - bNum;
    }).forEach(flat => {
        const count = monthData[flat] || 0;
        const amount = count * fee;
        
        if (count > 0) { // Only include if paid
            paidFlats++;
            totalPaidAmount += amount;
            paidRecords.push({ flat, amount, count });
        }
    });

    if (paidRecords.length === 0) {
        showMessage(`No payments recorded for ${month} yet.`, true);
        return;
    }

    // --- 2. Title and Summary ---
    doc.setFontSize(18).setFont(undefined, 'bold');
    doc.text(`Paid Maintenance Report - ${month}`, 105, 20, { align: 'center' });
    
    doc.setFontSize(14).setFont(undefined, 'normal');
    doc.text(`Total Collection: ‚Çπ${totalPaidAmount}`, 105, 30, { align: 'center' });
    doc.setFontSize(10).setFont(undefined, 'normal');
    doc.text(`Total Paid Flats: ${paidFlats}`, 105, 35, { align: 'center' }); // Only showing paid count
    
    // --- 3. Table Headers ---
    let y = 45;
    doc.line(10, y, 200, y); // Top line
    y += 7;
    
    doc.setFontSize(12).setFont(undefined, 'bold');
    doc.text("Flat No.", 15, y);
    doc.text("Payments", 75, y); 
    doc.text("Status", 125, y); // Keeping status for clarity
    doc.text("Amount (‚Çπ)", 185, y, { align: 'right' });

    y += 3;
    doc.line(10, y, 200, y); // Header bottom line
    y += 5;
    
    // --- 4. Table Data (Paginated) ---
    doc.setFont(undefined, 'normal');
    paidRecords.forEach(record => {
        doc.setFontSize(10);
        
        doc.text(record.flat, 15, y);
        doc.text("Paid", 125, y); // Status is always Paid here
        doc.text(String(record.amount), 185, y, { align: 'right' });
        
        // Custom logic for the 'Payments' column
        doc.text(`${record.count} month${record.count > 1 ? 's' : ''}`, 75, y);
        
        y += 6;
        
        // Page break logic
        if (y > 280) {
            doc.addPage();
            y = 20; // Start lower on the new page
            doc.setFontSize(10).setFont(undefined, 'italic');
            doc.text(`Paid Maintenance Report - ${month} (cont.)`, 10, 10);
            
            // Redraw headers on new page
            y = 25;
            doc.line(10, y, 200, y);
            y += 7;
            doc.setFontSize(12).setFont(undefined, 'bold');
            doc.text("Flat No.", 15, y);
            doc.text("Payments", 75, y);
            doc.text("Status", 125, y);
            doc.text("Amount (‚Çπ)", 185, y, { align: 'right' });
            y += 3;
            doc.line(10, y, 200, y);
            y += 5;
            doc.setFont(undefined, 'normal');
        }
    });
    
    doc.line(10, y, 200, y); // Final bottom line
    
    doc.save(`Paid_Maintenance_Report_${month}.pdf`);
}
// --- END UPDATED PDF EXPORT FUNCTION ---


// --- NEW ANALYTICS FUNCTION (ACCESSIBLE TO ALL) ---
async function showMonthlyAnalytics() {
  const month = monthSelect.value;
  await loadFromDB(month); // Ensure the data is up-to-date

  const monthData = data[month] || {};
  const floorCollections = {};

  // 1. Calculate total collection for each floor
  Object.keys(monthData).forEach(flat => {
    const countVal = Number(monthData[flat] || 0);
    const paidAmount = countVal * fee;

    let floorKey;
    if (flat.startsWith('G')) {
      floorKey = 'Ground Floor / ‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§´‡•ç‡§≤‡•ã‡§∞';
    } else {
      // Extracts the first two digits (the floor number)
      const floorNum = parseInt(flat.substring(0, 2), 10); 
      floorKey = `Floor ${floorNum} / ‡§Æ‡§Ç‡§ú‡§º‡§ø‡§≤ ${floorNum}`;
    }
    
    floorCollections[floorKey] = (floorCollections[floorKey] || 0) + paidAmount;
  });

  // 2. Convert to an array and sort by collection (descending)
  let sortedFloors = Object.keys(floorCollections).map(key => ({
    floor: key,
    total: floorCollections[key]
  }));
  
  sortedFloors.sort((a, b) => b.total - a.total);

  // 3. Format the output message
  let analyticsMessage = `üìä Monthly Analytics for ${month} / ${month} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£\n\n`;
  analyticsMessage += `üèÜ Best Paying Floors (Top 5) / ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§Æ‡§Ç‡§ú‡§º‡§ø‡§≤‡•á‡§Ç (‡§∂‡•Ä‡§∞‡•ç‡§∑ 5):\n`;
  
  const topFloors = sortedFloors.slice(0, 5);
  if (topFloors.length === 0) {
      analyticsMessage += "No payments recorded for this month. / ‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•ã‡§à ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§";
  } else {
      topFloors.forEach((item, index) => {
          analyticsMessage += `${index + 1}. ${item.floor}: ‚Çπ${item.total}\n`;
      });
  }

  // Use the built-in browser alert since this is an analytics report
  alert(analyticsMessage);
}
// END NEW ANALYTICS FUNCTION


// --- Payment Logic (Unchanged from last version, ensuring backend safety) ---

// Variable to store payment type selected (cash/upi)
let selectedPaymentType = null; 

function openPaymentModal(isUser=false) {
    selectedPaymentType = null;
    document.getElementById('paymentModal').classList.remove('hidden');
    document.getElementById('paymentModalTitle').textContent = "Select Payment Method";
    document.getElementById('paymentForm').classList.remove('hidden');
    document.getElementById('upiConfirmation').classList.add('hidden');

    // Show selection buttons initially (Cash and UPI)
    document.getElementById('cashPayBtn').classList.remove('hidden');
    document.getElementById('upiPayBtn').classList.remove('hidden');

    // Clear inputs and set amount
    document.getElementById('payName').value = '';
    document.getElementById('payFlatNo').value = '';
    document.getElementById('payFloorNo').value = '';
    document.getElementById('payAmount').textContent = `‚Çπ${fee}`;
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.add('hidden');
    // Hide all action buttons and confirmation screen on close
    document.getElementById('cashPayBtn').classList.add('hidden');
    document.getElementById('upiPayBtn').classList.add('hidden');
    document.getElementById('upiConfirmation').classList.add('hidden');
}

function handlePaymentSelection(type) {
    selectedPaymentType = type;
    
    // Validate inputs
    const name = document.getElementById('payName').value.trim();
    const flat = document.getElementById('payFlatNo').value.trim();
    const floor = document.getElementById('payFloorNo').value.trim();
    
    if (!name || !flat || !floor) {
        showMessage("Please fill in your Name, Flat No., and Floor No.", true);
        return;
    }

    // Hide initial selection buttons
    document.getElementById('cashPayBtn').classList.add('hidden');
    document.getElementById('upiPayBtn').classList.add('hidden');

    if (type === 'cash') {
        generateCashReceipt(name, flat, floor);
    } else if (type === 'upi') {
        handleUPIPayment(name, flat, floor);
    }
}

function generateCashReceipt(name, flat, floor) {
    // 1. Fill the hidden receipt template
    document.getElementById('receiptName').textContent = name;
    document.getElementById('receiptFlat').textContent = flat;
    document.getElementById('receiptFloor').textContent = floor;
    document.getElementById('receiptAmount').textContent = fee;
    document.getElementById('receiptDate').textContent = new Date().toLocaleDateString();
    document.getElementById('receiptID').textContent = `CASH-${Date.now()}`;

    // 2. Display the receipt container (briefly) and capture it for PDF
    const receiptEl = document.getElementById('receiptContainer');
    receiptEl.style.display = 'block';

    html2canvas(receiptEl, { scale: 2 }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;

        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        doc.save(`Maintenance_Cash_Receipt_${flat}.pdf`);
        
        // Hide the receipt template again
        receiptEl.style.display = 'none';

        showMessage("Cash receipt downloaded! Please make payment at 1812 E3.", false);
        closePaymentModal();
    });
}

function handleUPIPayment(name, flat, floor) {
    // 1. Construct the UPI deep link
    const upiUrl = new URL("upi://pay");
    upiUrl.searchParams.set('pa', UPI_ID);
    upiUrl.searchParams.set('pn', UPI_PAYEE_NAME);
    upiUrl.searchParams.set('am', fee); // Pre-entered amount of ‚Çπ100
    upiUrl.searchParams.set('cu', 'INR');
    upiUrl.searchParams.set('tn', `Maint_Flat_${flat}_${monthSelect.value}`);

    // 2. Open the UPI app
    window.open(upiUrl.href, '_blank');

    // 3. Show the WhatsApp confirmation step
    document.getElementById('paymentModalTitle').textContent = "Complete Payment";
    document.getElementById('paymentForm').classList.add('hidden');
    document.getElementById('upiConfirmation').classList.remove('hidden');

    // Store user data temporarily for WhatsApp message
    window.paymentDetails = { name, flat, floor };

    // --- Delay Logic (10 seconds) ---
    const btn = document.getElementById('whatsappNotifyBtn');
    const delaySeconds = 10;
    
    // Initial state: Disabled and showing countdown text
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    
    let countdown = delaySeconds;
    btn.innerHTML = `(Wait ${countdown} seconds...)`; // Set initial countdown text

    // Start countdown display using setInterval
    const timerInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            btn.innerHTML = `(Wait ${countdown} seconds...)`;
        } else {
            clearInterval(timerInterval);
            // Enable the button and update text
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '‚úÖ I have Paid! Send WhatsApp Message';
            showMessage("The WhatsApp button is now active!", false);
        }
    }, 1000); // Update every 1 second
}

function redirectToWhatsApp() {
    const { name, flat, floor } = window.paymentDetails;
    const amount = fee;
    const paymentMode = 'UPI ‚úÖ';
    
    // Construct the automated message
    const message = `Hello, I have paid my monthly maintenance.%0A%0AName: ${name}%0AFlat: ${flat}%0AFloor: ${floor}%0AAmount: ‚Çπ${amount}%0APayment Mode: ${paymentMode}%0A%0APlease find the screenshot attached here.`;
    
    const whatsappUrl = `${WHATSAPP_LINK}&text=${message}`;

    // Redirect to the WhatsApp group invite link with the pre-filled message
    window.open(whatsappUrl, '_blank');
    
    showMessage("Redirecting to WhatsApp!", false);
    closePaymentModal();
    
    // Clear temporary data
    window.paymentDetails = {};
}
// --- End New Payment Logic ---


monthSelect.value=months[new Date().getMonth()];
floorSelect.value=0;
resetPayments();
</script>
</body>
</html>
